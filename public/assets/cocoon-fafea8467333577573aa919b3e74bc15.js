(function(a){function b(a,b,c){reg_exp=new RegExp(b),a.replace(reg_exp,c)}function c(a){a.parent().parent().trigger("removal-callback")}a(".add_fields").live("click",function(b){b.preventDefault();var c=a(this),d=c.data("association"),e=c.data("associations"),f=c.data("template"),g=c.data("association-insertion-method")||c.data("association-insertion-position")||"before";insertionNode=c.data("association-insertion-node"),insertionCallback=c.data("insertion-callback"),removalCallback=c.data("removal-callback"),regexp_braced=new RegExp("\\[new_"+d+"\\]","g"),regexp_underscord=new RegExp("_new_"+d+"_","g"),new_id=(new Date).getTime(),newcontent_braced="["+new_id+"]",newcontent_underscord="_"+new_id+"_",new_content=f.replace(regexp_braced,"["+new_id+"]"),new_content==f&&(regexp_braced=new RegExp("\\[new_"+e+"\\]","g"),regexp_underscord=new RegExp("_new_"+e+"_","g"),new_content=f.replace(regexp_braced,"["+new_id+"]")),new_content=new_content.replace(regexp_underscord,newcontent_underscord),insertionNode?insertionNode=insertionNode=="this"?c:a(insertionNode):insertionNode=c.parent();var h=a(new_content);insertionNode[g](h),c.parent().trigger("insertion-callback")}),a(".remove_fields.dynamic").live("click",function(b){var d=a(this);c(d),b.preventDefault(),d.closest(".nested-fields").remove()}),a(".remove_fields.existing").live("click",function(b){var d=a(this);c(d),b.preventDefault(),d.prev("input[type=hidden]").val("1"),d.closest(".nested-fields").hide()})})(jQuery);